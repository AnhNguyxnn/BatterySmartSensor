{% extends "base.html" %}

{% block title %}Dashboard • Battery Smart Sensor{% endblock %}

{% block content %}
<div class="space-y-6">
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
    {% if readings and readings|length > 0 %}
    {% set latest = readings[0] %}
    <section class="rounded-xl border border-slate-200 bg-white p-4 shadow-sm">
      <h3 class="text-sm font-semibold text-slate-600">Thiết bị</h3>
      <div class="mt-2 text-slate-900 text-lg font-semibold">{{ latest.device_id }}</div>
      <dl class="mt-3 text-sm text-slate-600 space-y-1">
        <div class="flex items-center justify-between">
          <dt>Thời gian server</dt>
          <dd class="font-medium">{{ latest.created_at | datetime_to_local }}</dd>
        </div>
        <div class="flex items-center justify-between">
          <dt>Thời gian thiết bị</dt>
          <dd class="font-medium">{{ latest.timestamp | timestamp_to_datetime }}</dd>
        </div>
      </dl>
    </section>

    <section class="rounded-xl border border-slate-200 bg-white p-4 shadow-sm">
      <h3 class="text-sm font-semibold text-slate-600">Nhiệt độ</h3>
      <div class="mt-3 text-4xl font-extrabold tracking-tight">
        {{ '%.1f'|format(latest.temperature) }}<span class="text-base font-semibold ml-1">°C</span>
      </div>
      <p class="mt-2 text-xs text-slate-500">Cập nhật gần nhất ở trên</p>
    </section>

    <section class="rounded-xl border border-slate-200 bg-white p-4 shadow-sm">
      <h3 class="text-sm font-semibold text-slate-600">Trạng thái</h3>
      <div class="mt-3 flex flex-wrap gap-2">
        {% if latest.temp_alert %}<span class="px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-700">Temp</span>{% endif %}
        {% if latest.smoke_alert %}<span class="px-2 py-1 rounded-full text-xs font-medium bg-amber-100 text-amber-700">MQ-135</span>{% endif %}
        {% if latest.fire_alert %}<span class="px-2 py-1 rounded-full text-xs font-medium bg-orange-100 text-orange-700">KY-026</span>{% endif %}
      </div>
    </section>
    {% else %}
    <section class="rounded-xl border border-slate-200 bg-white p-6 shadow-sm sm:col-span-2 lg:col-span-3">
      <div class="text-slate-600">Chưa có dữ liệu. Hệ thống sẽ tự động làm mới.</div>
    </section>
    {% endif %}
  </div>

  <section class="rounded-xl border border-slate-200 bg-white p-4 shadow-sm">
    <div class="flex items-center justify-between">
      <h3 class="text-base font-semibold text-slate-700">Lịch sử gần đây</h3>
      <div class="text-xs text-slate-400">Hiển thị tối đa 50 bản ghi gần nhất</div>
    </div>
    <div class="table-wrap mt-3">
      <table class="min-w-full text-sm">
        <thead>
          <tr class="text-left text-slate-600">
            <th class="py-2 pr-3">Thời gian</th>
            <th class="py-2 pr-3">Nhiệt độ</th>
            <th class="py-2 pr-3">MQ-135</th>
            <th class="py-2 pr-3">Lửa (10-bit)</th>
            <th class="py-2 pr-3">Modules</th>
            <th class="py-2 pr-3">Thiết bị</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-slate-100">
          {% for r in readings %}
          <tr class="align-top">
            <td class="py-2 pr-3 whitespace-nowrap">{{ r.created_at | datetime_to_local }}</td>
            <td class="py-2 pr-3">{{ '%.1f'|format(r.temperature) }} °C</td>
            <td class="py-2 pr-3">{{ r.smoke_value }}</td>
            <td class="py-2 pr-3">{{ r.fire_value }}</td>
            <td class="py-2 pr-3">
              {% set mods = [] %}
              {% if r.temp_alert %}{% set _ = mods.append('Temp') %}{% endif %}
              {% if r.smoke_alert %}{% set _ = mods.append('MQ-135') %}{% endif %}
              {% if r.fire_alert %}{% set _ = mods.append('KY-026') %}{% endif %}
              {{ ', '.join(mods) if mods else '-' }}
            </td>
            <td class="py-2 pr-3 text-slate-600">{{ r.device_id }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>
</div>
{% endblock %}


